# Техническое видение подпроекта vodec

## Содержание
1. [Технологии и фреймворки](#технологии-и-фреймворки)
2. [Принципы разработки](#принципы-разработки)
3. [Структура проекта](#структура-проекта)
4. [Архитектура проекта](#архитектура-проекта)
5. [Модель данных](#модель-данных)
6. [Мониторинг](#мониторинг)
8. [Сценарии работы](#сценарии-работы)
9. [Компиляция и деплой](#компиляция-и-деплой)
10. [Подход к конфигурированию](#подход-к-конфигурированию)
11. [Подход к логгированию](#подход-к-логгированию)
12. [Подход к проектной документации](#подход-к-проектной-документации)
13. [План разработки](#план-разработки)

---

## 1. Технологии и фреймворки

### Основные технологии
- **Язык программирования**: C++20
- **GUI Framework**: Qt6 (Core, Network)
- **Математические библиотеки**: Eigen 3.4.0 (линейная алгебра, FFT)
- **Обработка аудио**: Custom DSP библиотеки
- **Конфигурация**: INI-файлы с custom parser

### Внешние зависимости
- **Eigen3.4.0**: Матричные операции, FFT преобразования
- **Qt6**: Базовые классы, сетевые возможности, логирование
- **Custom DSP**: Специализированные алгоритмы обработки сигналов

---

## 2. Принципы разработки

### Архитектурные принципы
- **Модульность**: Четкое разделение ответственности между компонентами
- **Интерфейсная изоляция**: Использование абстрактных базовых классов (ProtoUnit, InitUnit)
- **Обработка сигналов**: Pipeline архитектура для аудио обработки
- **Конфигурируемость**: Параметризация через INI-файлы

### Паттерны проектирования
- **Adapter Pattern**: VD_Core адаптирует CoreUnit к VD_Unit
- **Template Method**: Базовые классы определяют алгоритм, наследники реализуют детали
- **Observer Pattern**: CallBackProto для уведомлений о результатах
- **Factory Pattern**: Создание компонентов через инициализацию

---

## 3. Структура проекта

### Исходные файлы
```
src/vodec/
├── main.cpp                 # Точка входа приложения
├── vd_core.h/cpp           # Основной адаптер системы
├── vd_unit.h/cpp           # Реализация ProtoUnit интерфейса
├── vd_init.h/cpp           # Инициализация и конфигурация
├── vd_voicedetector.h/cpp  # Ядро алгоритма обнаружения
├── vd_artifanalizer.h      # Анализ артефактов
├── vd_coef.h              # Структуры коэффициентов
├── vodec.pro              # Qt проектный файл
└── docs/                  # Документация
    └── vision.md          # Данный документ
```

### Зависимости
```
src/include/
├── coreunit.h/cpp         # Базовый класс приложения
├── initunit.h/cpp         # Базовый класс инициализации
├── protounit.h            # Интерфейс обработки
├── dispunit.h/cpp         # Диспетчер задач
├── linkerudp.h/cpp        # UDP коммуникация
└── sp/                    # Signal Processing библиотеки
    ├── tdbuffer.h/cpp     # Time Domain буферы
    ├── fdbuffer.h         # Frequency Domain буферы
    ├── n_model.h          # Noise Model
    ├── vocaldetector.h    # Детектор голоса
    ├── spm.h              # Signal Processing Math
    └── artif_sign.h       # Структуры артефактов
```

---

## 4. Архитектура проекта

### Общая архитектура
```
┌─────────────────┐
│   VD_Core       │ ← Адаптер к общей архитектуре
├─────────────────┤
│   VD_Unit       │ ← Реализация ProtoUnit
├─────────────────┤
│ VD_VoiceDetector│ ← Основной алгоритм
├─────────────────┤
│ VD_ArtifactAn   │ ← Анализ артефактов
├─────────────────┤
│   VD_Init       │ ← Конфигурация
└─────────────────┘
```

### Поток обработки данных
```
WAV File → TDBuffer → FFT → FDBuffer → VocalDetector → ArtifactAnalyzer → Output WAV
           ↓
        NoiseModel ← (обновление модели шума)
```

### Компоненты системы
1. **VD_Core**: Тонкий адаптер, связывает общую архитектуру с конкретной реализацией
2. **VD_Unit**: Реализует интерфейс ProtoUnit, управляет жизненным циклом обработки
3. **VD_VoiceDetector**: Ядро алгоритма обнаружения голоса
4. **VD_ArtifactAnalizer**: Анализирует последовательности артефактов
5. **VD_Init**: Управляет конфигурацией и параметрами

---

## 5. Модель данных

### Основные структуры данных
```cpp
// Коэффициенты детектора голоса
struct VD_Coef_Frame {
    float VD_vocalRangeLoFreq;     // 60 Hz
    float VD_vocalRangeHiFreq;     // 400 Hz  
    float VD_ProbabilityThreshold; // 0.3
    float VD_powerThreshold;       // 0.15
};

// Коэффициенты модели шума
struct NM_Coef_Frame {
    float NM_scopeLength;            // 10.0
    float NM_weightRefreshThreshold; // 0.4
    float NM_noiseMixinCoef;         // 0.01
};

// Коэффициенты анализа артефактов
struct AA_Coef_Frame {
    unsigned AA_signalTimingThr; // в кадрах
    unsigned AA_pauseTimingThr;  // в кадрах
    float AA_freqTol;            // относительная толерантность
};
```

### Константы обработки
```cpp
using VDATA_T = float;
const size_t FDFrameSize = 1024;        // Размер FFT кадра
const size_t TDWindowSize = 2048;       // Размер временного окна
const size_t TDWinHopSize = 1024;       // Шаг окна
const size_t FDNumFramesInBuf = 128;    // Размер кольцевого буфера
```

### Экспорт данных
- **FDBuffer экспорт**: Массив частотных данных в NPY и TIFF форматах
- **SIGNATURE_T экспорт**: Массив подписей артефактов в NPY и TIFF форматах
- **Флаг экспорта**: `bool m_export_data` - управляет экспортом данных
- **Форматы экспорта**:
  - NPY: для анализа в Python/NumPy экосистеме
  - TIFF: для визуализации и интеграции с другими системами

---

## 6. Мониторинг

### Текущий мониторинг
- **Логирование**: Qt logging framework с записью в файл `log_vodec.txt`
- **Формат логов**: `[timestamp] file:function:line - [[message]]`
- **Состояние**: Базовое логирование через qInfo(), qDebug()

### Предлагаемые улучшения
1. **Метрики производительности**: Время обработки, использование памяти
2. **Статистика детекции**: Количество найденных артефактов, точность
3. **Системные метрики**: CPU, память, диск
4. **Алерты**: Уведомления о критических ошибках

---

## 7. Сценарии работы

### Режим тестирования (-t)
- Обработка одного WAV файла
- Сохранение дополнительной отладочной информации
- Экспорт данных при установленном флаге `m_export_data`
- Автоматическое завершение после обработки

### Режим одиночной задачи (-s)
- Обработка файла из INI конфигурации
- Остановка после завершения
- Использование предустановленных параметров

### Стандартный режим
- Работа под управлением BandMaster
- UDP коммуникация для получения задач
- Непрерывная обработка множественных файлов
- Отправка результатов через callback

### Алгоритм обработки
1. Загрузка WAV файла в TDBuffer
2. Применение оконной функции (Hann)
3. FFT преобразование в частотную область
4. Анализ голосового диапазона (60-400 Hz)
5. Обновление модели шума
6. Детекция артефактов голоса
7. Анализ последовательностей артефактов
8. Сохранение найденных фрагментов в WAV
9. Экспорт данных (FDBuffer, SIGNATURE_T) при включенном флаге `m_export_data`

---

## 8. Компиляция и деплой

### Система сборки
- **Build System**: qmake (Qt)
- **Компилятор**: C++20 совместимый
- **Целевые платформы**: Windows (MinGW), Linux, QNX

### Конфигурация сборки
```pro
QT = core network
CONFIG += c++20 cmdline
INCLUDEPATH += ../../../libs/eigen-3.4.0/
```

### Деплой
- **Windows**: `vodec.exe` в `bin/debug/` или `bin/release/`
- **Linux**: `/opt/vodec/bin/`
- **QNX**: `/tmp/vodec/bin/`

### Зависимости для деплоя
- Qt6 runtime libraries
- Eigen3.4.0 headers (включены в сборку)
- Системные библиотеки для аудио (WAV support)

---

## 9. Подход к конфигурированию

### Формат конфигурации
- **Формат**: INI файлы
- **Парсер**: Custom ini.h библиотека
- **Структура секций**:
  ```
  [TestConfig]
  WAVFile = path/to/test.wav
  
  [VoDec]
  VD_ProbabilityThreshold = 0.3
  VD_powerThreshold = 0.15
  VD_vocalRangeLoFreq = 60.0
  VD_vocalRangeHiFreq = 400.0
  
  [NoiseModel]
  NM_weightRefreshThreshold = 0.4
  NM_noiseMixinCoef = 0.01
  NM_scopeLength = 10.0
  
  [ArtifAn]
  AA_freqTol = 0.1
  AA_signalTimingThr = 5
  AA_pauseTimingThr = 10
  ```

### Динамическое переконфигурирование
- Поддержка изменения параметров через setOpt2()
- Перезагрузка конфигурации без перезапуска
- Валидация параметров при загрузке

---

## 10. Подход к логгированию

### Текущая реализация
```cpp
void logToFile(QtMsgType type, const QMessageLogContext &context, const QString &msg) {
    QString message = qFormatLogMessage(type, context, msg);
    static FILE *f = fopen("log_vodec.txt", "w");
    fprintf(f, "%s\n", qPrintable(message));
    fflush(f);
}
```

### Уровни логирования
- **qInfo()**: Основная информация о процессе
- **qDebug()**: Отладочная информация
- **qWarning()**: Предупреждения (не используется)
- **qCritical()**: Критические ошибки (не используется)

### Предлагаемые улучшения
1. **Ротация логов**: Ограничение размера, архивирование
2. **Структурированное логирование**: JSON формат
3. **Уровни детализации**: Настраиваемая детализация
4. **Централизованное логирование**: Отправка в внешнюю систему

---

## 11. Подход к проектной документации

### Структура документации
```
src/vodec/docs/
├── vision.md           # Техническое видение (данный файл)
├── api.md             # API документация
├── architecture.md    # Детальная архитектура
├── deployment.md      # Руководство по развертыванию
├── configuration.md   # Руководство по конфигурации
└── examples/          # Примеры использования
    ├── config.ini     # Пример конфигурации
    └── usage.md       # Примеры запуска
```

### Принципы документирования
- **Живая документация**: Обновление вместе с кодом
- **Примеры**: Практические примеры использования
- **API Reference**: Полное описание интерфейсов
- **Troubleshooting**: Решение типичных проблем

---

## 12. План разработки

### Итерация 1: Экспорт данных обработки (1-2 недели)
- [ ] Реализация флага `bool m_export_data` в VD_VoiceDetector
- [ ] Экспорт массива FDBuffer в NPY и TIFF форматы
- [ ] Экспорт массива SIGNATURE_T в NPY и TIFF форматы
- [ ] Настройка параметров экспорта через конфигурацию
- [ ] Тестирование экспорта данных

### Итерация 2: Стабилизация (2-3 недели)
- [ ] Исправление TODO в коде
- [ ] Улучшение обработки ошибок
- [ ] Стандартизация логирования
- [ ] Базовое тестирование

### Итерация 3: Мониторинг и метрики (2-3 недели)
- [ ] Система метрик
- [ ] Мониторинг производительности
- [ ] Алерты и уведомления
- [ ] Статистика детекции

### Итерация 4: Оптимизация (2-3 недели)
- [ ] Профилирование производительности
- [ ] Оптимизация алгоритмов
- [ ] Улучшение качества детекции
- [ ] Настройка параметров по умолчанию

---

*Документ создан: [Дата]*
*Версия: 1.0*
*Автор: [Имя]*
